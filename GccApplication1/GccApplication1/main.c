/*
 * segsu.c
 *
 * Created: 5/27/2023 1:41:43 PM
 * Author : diaag
 */ 



#include <avr/interrupt.h>
#include <time.h>
#ifndef F_CPU
#define F_CPU 8000000UL
#endif
#include <util/delay.h>

#include "Dio.h"
void delay_us(unsigned long us)
{
	while (us--) _delay_us(1);
}

#define RS			9
#define RW			10
#define EN			11
#define CS1			12
#define CS2			13
#define RST			14
#define SELECTBOTH()	Dio_Write_channel(CS1,!STD_HIGH) ;Dio_Write_channel(CS2,!STD_HIGH)
#define SELECTFIRST()	Dio_Write_channel(CS1,!STD_HIGH) ;Dio_Write_channel(CS2,!STD_LOW)
#define SELECTSECOND()	Dio_Write_channel(CS1,!STD_LOW) ;Dio_Write_channel(CS2,!STD_HIGH)
uint8_t dataport[] = {1,2,3,4,5,6,7,8};
uint8_t cmd[] = {RS,RW,EN,CS1,CS2,RST};
	
#define LOWVOLT		(0b10000000) 
#define HIGHVOLT	(0b00000001)
#define CHANGEVOLT	(0b11111111)
#define ZEROVOLT	(0b00010000)
 
const char font[][5]={
{0x00,0x00,0x00,0x00,0x00},	// 0x00
{0x1E,0x35,0x31,0x35,0x1E},	// 0x01
{0x1E,0x35,0x37,0x35,0x1E},	// 0x02
{0x0E,0x1F,0x3E,0x1F,0x0E},	// 0x03
{0x08,0x1C,0x7F,0x1C,0x08},	// 0x04
{0x18,0x4A,0x7F,0x4A,0x18},	// 0x05
{0x1C,0x4E,0x7F,0x4E,0x1C},	// 0x06
{0x00,0x00,0x00,0x00,0x00},	// 0x07
{0x00,0x00,0x00,0x00,0x00},	// 0x08
{0x00,0x00,0x00,0x00,0x00},	// 0x09
{0x00,0x00,0x00,0x00,0x00},	// 0x0A
{0x38,0x44,0x44,0x47,0x3B},	// 0x0B
{0x0E,0x51,0xF1,0x51,0x0E},	// 0x0C
{0x00,0x00,0x00,0x00,0x00},	// 0x0D
{0x60,0x7E,0x02,0x33,0x3F},	// 0x0E
{0x2A,0x1C,0x36,0x1C,0x2A},	// 0x0F
{0x3E,0x1C,0x1C,0x08,0x08},	// 0x10
{0x08,0x08,0x1C,0x1C,0x3E},	// 0x11
{0x00,0x22,0x7F,0x22,0x00},	// 0x12
{0x00,0x2E,0x00,0x2E,0x00},	// 0x13
{0x06,0x7F,0x01,0x7F,0x00},	// 0x14
{0x00,0x4A,0x55,0x29,0x00},	// 0x15
{0x00,0x18,0x18,0x18,0x18},	// 0x16
{0x00,0x4A,0x5F,0x4A,0x00},	// 0x17
{0x00,0x02,0x7F,0x02,0x00},	// 0x18
{0x00,0x20,0x7F,0x20,0x00},	// 0x19
{0x00,0x08,0x08,0x1C,0x08},	// 0x1A
{0x00,0x08,0x1C,0x08,0x08},	// 0x1B
{0x00,0x3C,0x20,0x20,0x20},	// 0x1C
{0x08,0x1C,0x08,0x1C,0x08},	// 0x1D
{0x20,0x38,0x3E,0x38,0x20},	// 0x1E
{0x02,0x0E,0x3E,0x0E,0x02},	// 0x1F
{0x00,0x00,0x00,0x00,0x00},	// 0x20
{0x00,0x00,0x2F,0x00,0x00},	// 0x21
{0x00,0x03,0x00,0x03,0x00},	// 0x22
{0x34,0x1C,0x36,0x1C,0x16},	// 0x23
{0x00,0x26,0x7F,0x32,0x00},	// 0x24
{0x32,0x0D,0x1E,0x2C,0x13},	// 0x25
{0x18,0x26,0x2D,0x12,0x28},	// 0x26
{0x00,0x00,0x03,0x00,0x00},	// 0x27
{0x00,0x1C,0x22,0x41,0x41},	// 0x28
{0x41,0x41,0x22,0x1C,0x00},	// 0x29
{0x00,0x0A,0x05,0x0A,0x00},	// 0x2A
{0x00,0x10,0x38,0x10,0x00},	// 0x2B
{0x00,0x80,0x60,0x00,0x00},	// 0x2C
{0x00,0x08,0x08,0x08,0x00},	// 0x2D
{0x00,0x00,0x20,0x00,0x00},	// 0x2E
{0x00,0x60,0x18,0x06,0x01},	// 0x2F
{0x00,0x1E,0x21,0x21,0x1E},	// 0x30
{0x00,0x22,0x3F,0x20,0x00},	// 0x31
{0x00,0x31,0x29,0x26,0x00},	// 0x32
{0x00,0x25,0x25,0x1A,0x00},	// 0x33
{0x00,0x0C,0x0A,0x3F,0x08},	// 0x34
{0x00,0x27,0x25,0x19,0x00},	// 0x35
{0x00,0x1E,0x25,0x25,0x18},	// 0x36
{0x00,0x01,0x39,0x05,0x03},	// 0x37
{0x00,0x1A,0x25,0x25,0x1A},	// 0x38
{0x00,0x06,0x29,0x29,0x1E},	// 0x39
{0x00,0x00,0x24,0x00,0x00},	// 0x3A
{0x00,0x80,0x64,0x00,0x00},	// 0x3B
{0x00,0x08,0x08,0x14,0x22},	// 0x3C
{0x00,0x14,0x14,0x14,0x14},	// 0x3D
{0x00,0x22,0x14,0x08,0x08},	// 0x3E
{0x00,0x01,0x29,0x05,0x02},	// 0x3F
{0x3C,0x42,0x59,0x55,0x5E},	// 0x40
{0x30,0x1C,0x12,0x1C,0x30},	// 0x41
{0x00,0x3E,0x2A,0x36,0x00},	// 0x42
{0x00,0x1C,0x22,0x22,0x22},	// 0x43
{0x00,0x3E,0x22,0x22,0x1C},	// 0x44
{0x00,0x3E,0x2A,0x2A,0x00},	// 0x45
{0x00,0x3E,0x0A,0x0A,0x00},	// 0x46
{0x00,0x1C,0x22,0x2A,0x3A},	// 0x47
{0x00,0x3E,0x08,0x08,0x3E},	// 0x48
{0x00,0x22,0x3E,0x22,0x00},	// 0x49
{0x00,0x22,0x22,0x1E,0x00},	// 0x4A
{0x00,0x3E,0x08,0x14,0x22},	// 0x4B
{0x00,0x3E,0x20,0x20,0x20},	// 0x4C
{0x3E,0x04,0x18,0x04,0x3E},	// 0x4D
{0x00,0x3E,0x04,0x08,0x3E},	// 0x4E
{0x1C,0x22,0x22,0x22,0x1C},	// 0x4F
{0x00,0x3E,0x0A,0x0A,0x04},	// 0x50
{0x1C,0x22,0x22,0x62,0x9C},	// 0x51
{0x00,0x3E,0x0A,0x14,0x20},	// 0x52
{0x00,0x24,0x2A,0x12,0x00},	// 0x53
{0x02,0x02,0x3E,0x02,0x02},	// 0x54
{0x00,0x1E,0x20,0x20,0x1E},	// 0x55
{0x00,0x0E,0x30,0x30,0x0E},	// 0x56
{0x0E,0x30,0x0C,0x30,0x0E},	// 0x57
{0x22,0x14,0x08,0x14,0x22},	// 0x58
{0x02,0x04,0x38,0x04,0x02},	// 0x59
{0x00,0x32,0x2A,0x2A,0x26},	// 0x5A
{0x00,0x00,0x7F,0x41,0x00},	// 0x5B
{0x01,0x06,0x18,0x60,0x00},	// 0x5C
{0x00,0x41,0x7F,0x00,0x00},	// 0x5D
{0x18,0x06,0x01,0x06,0x18},	// 0x5E
{0x40,0x40,0x40,0x40,0x40},	// 0x5F
{0x00,0x01,0x02,0x00,0x00},	// 0x60
{0x00,0x34,0x34,0x38,0x20},	// 0x61
{0x00,0x3F,0x24,0x24,0x18},	// 0x62
{0x00,0x18,0x24,0x24,0x00},	// 0x63
{0x18,0x24,0x24,0x3F,0x00},	// 0x64
{0x00,0x18,0x2C,0x28,0x00},	// 0x65
{0x00,0x04,0x3E,0x05,0x05},	// 0x66
{0x00,0x58,0x54,0x54,0x3C},	// 0x67
{0x00,0x3F,0x08,0x04,0x38},	// 0x68
{0x00,0x04,0x3D,0x00,0x00},	// 0x69
{0x00,0x44,0x44,0x3D,0x00},	// 0x6A
{0x00,0x3F,0x08,0x14,0x20},	// 0x6B
{0x00,0x01,0x3F,0x00,0x00},	// 0x6C
{0x3C,0x08,0x3C,0x08,0x3C},	// 0x6D
{0x00,0x3C,0x08,0x04,0x38},	// 0x6E
{0x00,0x18,0x24,0x24,0x18},	// 0x6F
{0x00,0x7C,0x24,0x24,0x18},	// 0x70
{0x18,0x24,0x24,0x7C,0x00},	// 0x71
{0x00,0x3C,0x08,0x04,0x00},	// 0x72
{0x00,0x28,0x2C,0x14,0x00},	// 0x73
{0x00,0x04,0x1E,0x24,0x04},	// 0x74
{0x00,0x1C,0x20,0x10,0x3C},	// 0x75
{0x00,0x0C,0x30,0x30,0x0C},	// 0x76
{0x0C,0x30,0x1C,0x30,0x0C},	// 0x77
{0x00,0x24,0x18,0x18,0x24},	// 0x78
{0x40,0x4C,0x70,0x30,0x0C},	// 0x79
{0x00,0x34,0x2C,0x2C,0x00},	// 0x7A
{0x00,0x08,0x36,0x41,0x00},	// 0x7B
{0x00,0x00,0x7F,0x00,0x00},	// 0x7C
{0x00,0x41,0x36,0x08,0x00},	// 0x7D
{0x10,0x08,0x08,0x10,0x08},	// 0x7E
{0x00,0x3C,0x22,0x3C,0x00},	// 0x7F
{0x00,0x1C,0xA2,0x62,0x22},	// 0x80
	};
	
void GLCD_Command(char Command)		/* GLCD command function */
{
	Dio_Write_channel_group(dataport,8,Command);		/* Copy command on data pin */
	Dio_Write_channel(RS,STD_LOW) ;						/* Make RS LOW for command register*/
	Dio_Write_channel(RW,STD_LOW) ;						/* Make RW LOW for write operation */
	Dio_Write_channel(EN,STD_HIGH); 					/* Make HIGH-LOW transition on Enable */
	_delay_us(5);
	Dio_Write_channel(EN,STD_LOW); 
	_delay_us(5);
}

void GLCD_Data(char Data)		/* GLCD data function */
{
	Dio_Write_channel_group(dataport,8,Data);		/* Copy command on data pin */
	Dio_Write_channel(RS,STD_HIGH) ;						/* Make RS LOW for command register*/
	Dio_Write_channel(RW,STD_LOW) ;						/* Make RW LOW for write operation */
	Dio_Write_channel(EN,STD_HIGH); 					/* Make HIGH-LOW transition on Enable */
	_delay_us(5);
	Dio_Write_channel(EN,STD_LOW);
	_delay_us(5);
}

void GLCD_Init()			/* GLCD initialize function */
{
		Dio_dir dataportdir[] ={STD_OUTPUT,STD_OUTPUT,STD_OUTPUT,STD_OUTPUT,STD_OUTPUT,STD_OUTPUT,STD_OUTPUT,STD_OUTPUT};
		Dio_init_channel_group(dataport,	8,	dataportdir);

		
		Dio_dir cmddir[] ={STD_OUTPUT,STD_OUTPUT,STD_OUTPUT,STD_OUTPUT,STD_OUTPUT,STD_OUTPUT};
		Dio_init_channel_group(cmd,	6,	cmddir);

	/* Select both left & right half of display & Keep reset pin high */
	SELECTBOTH();					
	Dio_Write_channel(RST,STD_HIGH) ;				
	
	_delay_ms(20);
	GLCD_Command(0x3E);		/* Display OFF */
	GLCD_Command(0x40);		/* Set Y address (column=0) */
	GLCD_Command(0xB8);		/* Set x address (page=0) */
	GLCD_Command(0xC0);		/* Set z address (start line=0) */
	GLCD_Command(0x3F);		/* Display ON */
}
void GLCD_PrintChar(char x,uint8_t row,uint8_t col)
{
	int i = col ;
	for(i = col; i < 5+col; i++)
		{		
		if (64==i) {
					SELECTSECOND();
					GLCD_Command(0x40);		/* Set Y address (column=0) */
					GLCD_Command(0xB8+row);
					}
		GLCD_Data(font[x][i-col]);
		}
}
void Print_String(char* x,uint8_t row)
{
	int i = 0,col =0; 
	SELECTFIRST();
	GLCD_Command(0x40);	
	GLCD_Command((0xB8) + row);
	
	while (x[i])
	{
		GLCD_PrintChar(x[i],row,col);
		i++; col+=5;
	}
}
void GLCD_ClearAll()			/* GLCD all display clear function */
{
	int i,j;

	SELECTBOTH();
for(i = 0; i < 8; i++)
	{	
		
		GLCD_Command(0x40);	
		GLCD_Command((0xB8) + i);

		for(j = 0; j < 64 ; j++)
		{	
			GLCD_Data(0);	/* Write zeros to all 64 column */
			//delay_us(5000);
		}
	} 
	GLCD_Command(0x40);		/* Set Y address (column=0) */
	GLCD_Command(0xB8);		/* Set x address (page=0) */


}

int main(void)
{
	GLCD_Init();
	GLCD_ClearAll();
	Print_String("PWM Signal ",1);

	int pwmvalue = 0;
	int timefactor = 10;
	char duty[] = "Duty Cycle = 00 %";
	char freq[] = "frequency =	320 KHZ";
	while(1)
	{
		SELECTFIRST();
		GLCD_Command(0x40);		/* Set Y address (column=0) */
		GLCD_Command(0xB8+2);		/* Set x address (page=0) */
		int dc = pwmvalue*100/256;
		duty[13] = dc/10+'0';
		duty[14] = dc%10+'0';
		Print_String(duty,2);
		Print_String(freq,3);
		
		SELECTFIRST();
		GLCD_Command(0x40);		/* Set Y address (column=0) */
		GLCD_Command(0xB8+5);
		
		
		int x = pwmvalue/timefactor;
		int k = 0;
		int nextk = 256/timefactor;
		for (int i = 0 ;i<128;i++)
		{
			if (64==i) {
				SELECTSECOND();
				GLCD_Command(0x40);		/* Set Y address (column=0) */
				GLCD_Command(0xB8+5);
			}
			if (i == nextk)
			{
				GLCD_Data(CHANGEVOLT);
				k = nextk;
				nextk = 256/timefactor+i;
				
			}
			else if (i == x +k )
			{
				GLCD_Data(CHANGEVOLT);
			}
			
			else if(i > x+k)
			{
				GLCD_Data(LOWVOLT);
			}
			else {
				GLCD_Data(HIGHVOLT);
			}
	
		}
		pwmvalue += 10;
		if (pwmvalue >255)pwmvalue = 0;
		_delay_ms(100);
	}
}